#STM32 DFU

IAP(In Application Programming):  Serial, Network, USB

USB IAP allow users to update firmware without extra hardware

通常在用户需要实现IAP功能时，即用户程序运行中作自身的更新操作，需要在设计固件程序时编写两个项目代码，第一个项目程序不执行正常的功能操作，而只是通过某种通信管道(如USB、UART)接收程序或数据，执行对第二部分代码的更新；第二个项目代码才是真正的功能代码。这两部分项目代码都同时烧录在User Flash中，当芯片上电后，首先是第一个项目代码开始运行，它作如下操作：

1）检查是否需要对第二部分代码进行更新
2）如果不需要更新则转到4）
3）执行更新操作
4）跳转到第二部分代码执行

第一部分代码必须通过其它手段，如JTAG或ISP烧入；第二部分代码可以使用第一部分代码IAP功能烧入，也可以和第一部分代码一道烧入，以后需要程序更新是再通过第一部分IAP代码更新。

对于STM32来说，因为它的中断向量表位于程序存储器的最低地址区，为了使第一部分代码能够正确地响应中断，通常会安排第一部分代码处于Flash的开始区域，而第二部分代码紧随其后。
在第二部分代码开始执行时，首先需要把CPU的中断向量表映像到自己的向量表，然后再执行其他的操作。
如果IAP程序被破坏，产品必须返厂才能重新烧写程序，这是很麻烦并且非常耗费时间和金钱的。针对这样的需求，STM32在对Flash区域实行读保护的同时，自动地对用户Flash区的开始4页设置为写保护，这样可以有效地保证IAP程序(第一部分代码)区域不会被意外地破坏。
